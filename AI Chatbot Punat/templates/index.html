<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Punat – AI asistent (prototip)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .notice { background: #fff3cd; border: 1px solid #ffeeba; padding: 12px; border-radius: 10px; }
    .card { background: white; border-radius: 12px; padding: 14px; margin-top: 12px; box-shadow: 0 1px 6px rgba(0,0,0,.06); }
    .chat { height: 55vh; overflow: auto; padding: 10px; border: 1px solid #e6e6e6; border-radius: 10px; background: #fff; }
    .msg { margin: 10px 0; }
    .me { font-weight: 600; }
    .bot { font-weight: 600; }
    .bubble { margin-top: 6px; white-space: pre-wrap; line-height: 1.35; }
    .row { display: flex; gap: 10px; margin-top: 10px; }
    input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; background: #1a73e8; color: white; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .sources a { color: #1a73e8; text-decoration: none; }
    .sources { margin-top: 8px; font-size: 0.95em; color: #333; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="notice">
      <div style="font-weight:700">{{ notice.title }}</div>
      <div style="margin-top:6px">{{ notice.body }}</div>
      <div style="margin-top:6px; font-size:.95em;"><i>{{ notice.data_sources }}</i></div>
    </div>

    <div class="card">
      <div class="chat" id="chat"></div>

      <div class="row">
        <input id="msg" placeholder="Postavi pitanje (npr. radno vrijeme, kontakt, dokumenti...)" />
        <button id="send">Pošalji</button>
      </div>
    </div>
  </div>

<script>
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const send = document.getElementById("send");

function addMessage(who, text, sources=[]) {
  const wrap = document.createElement("div");
  wrap.className = "msg";

  const title = document.createElement("div");
  title.className = who === "user" ? "me" : "bot";
  title.textContent = who === "user" ? "Vi" : "AI asistent";
  wrap.appendChild(title);

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;
  wrap.appendChild(bubble);

  if (sources && sources.length) {
    const src = document.createElement("div");
    src.className = "sources";
    src.innerHTML = "<b>Izvori:</b> " + sources.map(s => {
      const url = s.url;
      const score = (s.score ?? 0).toFixed(3);
      return `<a href="${url}" target="_blank" rel="noopener">${url}</a> (score ${score})`;
    }).join(" • ");
    wrap.appendChild(src);
  }

  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMsg() {
  const text = msg.value.trim();
  if (!text) return;

  addMessage("user", text);
  msg.value = "";
  send.disabled = true;

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({message: text})
    });
    const data = await res.json();
    addMessage("bot", data.answer || "Greška u odgovoru.", data.sources || []);
  } catch (e) {
    addMessage("bot", "Dogodila se greška pri komunikaciji sa serverom.");
  } finally {
    send.disabled = false;
    msg.focus();
  }
}

send.addEventListener("click", sendMsg);
msg.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMsg();
});
</script>
</body>
</html>
